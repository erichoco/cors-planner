define(["require","exports","module","helper/jquery.slot","hgn!template/timeSlot"],function(e,t){function r(e){this.name=e.toLowerCase(),this.$elem=$("#"+this.name),this.$rows=[];var t,n,r=this.$elem.find(".row-fluid");for(t=0,n=r.length;t<n;t++)this.$rows.push($(r[t]));$.subscribe("grid:rows:clearEmpty",$.proxy(this.removeEmptyRows,this))}function i(e,t,n,r){var i=e+t,s=n+r;return n>=e&&n<i?!0:s>e&&s<=i?!0:n<=e&&s>=i?!0:!1}function s(e){return e=parseInt(e,10),2+(Math.floor(e/100)-8)*2+(e%100?1:0)}function o(e){var t=e.toUpperCase().split("-");return t[0].indexOf("LAB")>=0?"(LB)":t.length===3?"("+t[0].charAt(0)+t[2].charAt(0)+")":t.length===2?"("+t[0].charAt(0)+t[1].charAt(0)+")":"("+t[0].charAt(0)+")"}function u(e){var t=$(n(e));return t.slot(e),t}e("helper/jquery.slot");var n=e("hgn!template/timeSlot");return r.fn=r.prototype,r.fn.allocate=function(e,t,n,r,i){var a=s(t.startTime),f=s(t.endTime)-a,l=this.hasEmptySlots(a,f);l===-1&&(this.createNewRow(),l=this.$rows.length-1);var c={code:r.get("code"),type:n,shortType:o(t.type),index:e,offset:a,span:f,slot:t,data:r.data,module:r,droppable:i||!1};this.$rows[l].append(u(c)),this.$elem.hasClass("hidden")&&(this.$elem.removeClass("hidden"),$(window).resize())},r.fn.createNewRow=function(){var e=this.$rows[1].clone();e.find(".slot").remove(),this.$rows.push(e),this.$elem.append(e),$(window).resize()},r.fn.removeEmptyRows=function(){var e,t;for(e=this.$rows.length-1;e>1;e--)this.$rows[e].find(".slot").length===0&&(this.$rows[e].remove(),this.$rows.splice(e,1));this.$rows[0].find(".slot").length===0&&(e=this.$rows.length===2?1:2,t=this.$rows[e].find(".slot").detach(),this.$rows[0].append(t),e===2&&(this.$rows[2].remove(),this.$rows.splice(e,1))),this.$rows[1].find(".slot").length===0&&this.$rows.length>2&&(t=this.$rows[2].find(".slot").detach(),this.$rows[1].append(t),this.$rows[2].remove(),this.$rows.splice(2,1)),this.$rows[0].find(".slot").length>0?this.mergeRows():this.name==="saturday"&&this.$elem.addClass("hidden"),$(window).resize()},r.fn.mergeRows=function(){var e,t,n,r,i,s;for(e=this.$rows.length-1;e>0;e--){i=this.$rows[e].find(".slot");for(t=i.length-1,n=0;t>=0;t--)s=$(i[t]),r=this._hasEmptySlots(s.data("offset"),s.data("span"),e),r!==-1&&(s.detach(),this.$rows[r].append(s),n++);n!==0&&e!==1&&n===i.length&&(this.$rows[e].remove(),this.$rows.splice(e,1))}},r.fn._hasEmptySlots=function(e,t,n){var r,s,o,u,a,f;for(s=0;s<n;s++){r=!0,a=this.$rows[s].find(".slot");for(o=0,u=a.length;o<u;o++){f=$(a[o]);if(i(f.data("offset"),f.data("span"),e,t)){r=!1;break}}if(r)return s}return-1},r.fn.hasEmptySlots=function(e,t){return this._hasEmptySlots(e,t,this.$rows.length)},r});